% DOCUMENT CLASS
    \documentclass[a4,12pt]{article}

	
    \usepackage{authblk} % For multiple authors
    \usepackage{amsmath}
    \usepackage[utf8]{inputenc}
 	\usepackage{times}
 	\usepackage{setspace} % lines spacing
    \usepackage{lineno} 	% See \linenumbers at the top of content.tex
    \usepackage{booktabs}
    \usepackage[skip=2.5\baselineskip]{caption} % to give more space between figs and captions
    \usepackage{listings} % allows me to insert code 
    \usepackage{pdfpages}
    \usepackage[margin=20mm]{geometry} % set exact margins 
    \usepackage{caption} % allows doublespacing of captions
    \usepackage{hyperref} % allows adding urls
    \captionsetup{font=doublespacing}

% REFERENCES
    \usepackage[firstinits=true, backend=biber, style=authoryear, maxcitenames=2, url=false, isbn=false, doi=true, eprint=false]{biblatex}
    \DeclareNameAlias{sortname}{last-first}

    \addbibresource{../../../../BibTex_files/03_Chapter3.bib}

% GRAPHICS
    \usepackage{graphicx} % More advanced figure inclusion
    \usepackage{float} % For specifying table/figure locations, i.e. [ht!]
    \usepackage{changepage}
    \usepackage[table,xcdraw]{xcolor}

\doublespacing 

\title{\large Estimating interaction matrices from performance data for diverse systems}



\author[1]{\small Malyon D. Bimler *}
\author[2]{\small Margaret M. Mayfield}
\author[3]{\small Trace E. Martyn}
\author[4]{\small Daniel B. Stouffer}

\affil[1]{\footnotesize School of Biological Sciences, The University of Queensland, St Lucia, Queensland, Australia. Email: malyonbimler@gmail.com}
\affil[2]{\footnotesize School of BioSciences, The University of Melbourne, Parkville, Victoria, Australia. Email: margie.mayfield@unimelb.edu.au}
\affil[3]{\footnotesize School of Natural Resources and the Environment, The University of Arizona, Tucson, USA. Email: tmartyn@arizona.edu }
\affil[4]{\footnotesize Centre for Integrative Ecology, School of Biological Sciences, University of Canterbury, Christchurch, New Zealand. Email: daniel.stouffer@canterbury.ac.nz }



\setlength{\intextsep}{10ex}

\begin{document}
\maketitle  

% \noindent
% \textbf{Running title:} Estimating horizontal interaction matrices

\noindent
\textbf{Corresponding Author:} Malyon D. Bimler, email: malyonbimler@gmail.com \\ %, ph: +64 481941634\\




\noindent
Number of words - Abstract: 192\\
Number of words - main text: 5570\\
3 Figures in main text.\\
Number of references: 85\\

\noindent
\textbf{Keywords:} Species interactions, competition, facilitation, network, population dynamics, interaction strength, non-trophic, annual plants.  

\section*{Author contributions}

M.D.B. designed the methodology, carried out analyses and led the drafting of the manuscript. M.M.M. helped design the field study, collected data, contributed to the interpretation of analyses and critically revised the manuscript. T.E.M. led the field study and data collection. D.B.S. helped design the methodology, interpret analyses and critically revised the manuscript. 

\section*{Data accessibility}

Data will be submitted to Dryad upon publication.

\newpage


\linenumbers

\section*{Abstract}
    
    \begin{enumerate}
    \item{Network theory allows us to understand complex systems by evaluating how their constituent elements interact with one another. Such networks are built from matrices which describe the effect of each element on all others. Quantifying the strength of these interactions from empirical data can be difficult, however, because the number of potential interactions increases non-linearly as more elements are included in the system, and not all interactions may be empirically observable when some elements are rare.}
    \item{We present a novel modelling framework which estimates the strength of pairwise interactions in diverse horizontal systems, using measures of species performance in the presence of varying densities of their potential interaction partners. \textbf{We show how to link this framework to a population dynamics model to make inferences about the effect of interactions on community dynamics and diversity.}}
    \item{Our method allows us to directly estimate pairwise effects when they are statistically identifiable and approximate pairwise effects when they would otherwise be statistically unidentifiable. The resulting interaction matrices can include positive and negative effects, the effect of a species on itself, and are non-symmetrical.} 
    \item{The advantages of these features are illustrated with a case study on an annual wildflower community of 22 focal and 52 neighbouring species, and a discussion of potential applications of this framework extending well beyond plant community ecology.}
\end{enumerate}
% Abstract = 217 words
% 350 word limit for MEE

\begin{refsection}

\section{Introduction}

    
    \paragraph{}
    In many biological systems, interactions between system elements (be these species, individuals, etc.) affect population-level performance and together determine the dynamics of the whole system. In order to understand system dynamics when multiple system elements are involved, such complex systems can be represented as networks where the elements are nodes and linked by interactions \parencite{Pimm1978}. These nodes can take on a wide array of identities, including cells, individuals, populations or species. Likewise, interactions or links can operate via many different mechanisms and have a wide range of effects on the nodes. Biological networks have been observed to typically differ from randomly-assembled networks in important and varied ways, thus informing us on the biological processes structuring these systems \parencite{Dunne2002, Kinlock2019}.

    \paragraph{}
    Network theory has been widely applied to investigate the structure of biological systems such as food webs and other types of multi-level ecological interaction networks. Because network theory can be used to characterise diversity, stability and other community-level properties emerging from species interactions, it has had a long and meaningful impact on our understanding of ecological communities. There is now a rich body of work describing the structural properties of food webs, plant-pollinator networks, and host-parasite interactions (e.g.\ \cite{Lafferty2008, Thompson2012, Dunne2013, Stouffer2014, Cirtwill2015a}). Horizontal networks, however, where interactions occur within the same level of organisation (for example interactions between plants belonging to the same food web) have been more neglected by network ecology \parencite{Ellison2019}. These species and their interactions have been found to alter the structure, stability and diversity-functioning relationships of the whole multi-level system \parencite{Hammill2015, Giling2019, Zhao2019, Miele2019}, which makes integrating horizontal and vertical networks a key challenge in improving our understanding of system dynamics and persistence \parencite{Godoy2018c}.

    %\paragraph{} % I reckon this paragraph can be cut?? It doesn't bring that much to the intro... Can be kept for MEE
    %In many horizontal systems, interactions between nodes are not always easy to observe empirically and must instead be deduced through other means. One strategy is to look at associations between the nodes: nodes which are often found together are assumed to interact more strongly than nodes which rarely co-occur (e.g. \cite{Araujo2011}). This approach benefits from a wide range of packages available in R, requires fairly simple data (presence/absence of the nodes) and can be used to deduce associations between large numbers of nodes. An important drawback remains: association networks cannot always distinguish between the multiple confounding factors which lead to co-occurrence, and in ecological communities little evidence supports their use as a proxy for interactions \parencite{Sander2017,Barner2018, Thurman2019, Blanchet2020}.
    %% [Keep this if I have enough spare words]

    \paragraph{} 
    In many horizontal systems, interactions between species are not always easy to observe empirically and must instead be deduced through other means. A common approach in ecology is to directly quantify the effects of interacting species on the species of interest by evaluating its performance in the absence and presence of potential interaction partners \parencite{Connell1961, Grace1990}. `Performance' can refer to any variable of interest that affects the dynamics of the system, for example quantity of resources gathered, biomass, or population growth rate. \textbf{Measuring species interactions as effects on performance allows us to infer future population trajectories through the use of population dynamics models, and thus draw conclusions about the effects of interactions on potential coexistence and diversity \parencite{Laska1998}.} The resulting interactions are phenomenological and thus not dependent on any specific mechanism, allowing us to capture a wide range of biological processes affecting the dynamics of the whole system \parencite{Novak2010}. Such methods can quickly become data intensive and computationally complex, however, as the number of species $S$ increases and the number of potential direct interactions subsequently increases to $S^2$. Highly diverse systems pose a further challenge: the abundance distribution of different species is typically skewed, with a few species making up the majority of abundances and a large number of elements remaining rare \parencite{Fisher1943}. Given that data collection is limited in time and scope, interactions with rarer species especially may not be observed simply by chance. We thus run the risk of excluding them from analyses regardless of the role they might play \parencite{Olesen2011}. Empirically quantifying interaction matrices for diverse horizontal systems thus requires a method that is flexible to both a high number of species, and potential gaps in our records of interactions. 


    \paragraph{} 
    We present a general framework to estimate interactions in diverse horizontal systems. We specify a joint model which allows us to estimate both pairwise identifiable and pairwise unidentifiable interactions from measures of performance in the absence and presence of different interaction partners. We implement the model in STAN, a Bayesian statistical language, and apply it to an ecological case study of an annual wildflower community in Western Australia. Using this dataset, we estimate positive and negative interactions between 22 focal species and 52 neighbouring species and illustrate how to couch these results into established models of population dynamics. This step further widens the potential applications of this novel framework by accounting for other demographic processes affecting species or element performance, and thus system dynamics. We showcase the advantages of this approach by illustrating a range of findings from our case study. We suggest potential applications in species management and conservation that make use of the rich information provided by horizontal interaction networks as developed using our novel framework.


\section{Methods}

\paragraph{} 
We developed a joint modeling framework to estimate pairwise interactions which benefits from several distinguishing features including the ability to estimate both \textit{identifiable} interactions (direct estimates from the observed data) and \textit{unidentifiable} interactions (when observations are missing or too few). After describing the required data (\ref{meth:data} below), we show how one can estimate identifiable interactions with a unique interaction parameter as described in the neighbour-density dependent model (\ref{meth:nddm}).
% edit below
We then show how to define and select which interactions are identifiable and which are not (\ref{meth:id_params}) based on the data available. Independently from the first model, we also describe a response--impact model (\ref{meth:rim}) where species have a singular effect on neighbours, and a singular response. This allows us to estimate unidentifiable interactions as the product of element-specific response and impact parameters. Both models contribute to the overall joint model likelihood as detailed in \ref{meth:addlog}.
Taken together, identifiable and unidentifiable interaction estimates are then used to populate community interaction matrices for the system that describes the effects of all interaction partners on the performance of all focal species. 

%, i.e. when elements are observed to co-occur enough times and at varying densities such that the effect of one element on the performance of the other can be reliably estimated via regression. Conversely, the interaction effect of element $j$ on element $i$ is is deemed unidentifiable when there are none or too few measures of the performance of $i$ in the presence of varying densities of $j$. 



    \subsection{Data requirements}
    \label{meth:data}

    \paragraph{}
    The joint model framework was initially developed for an ecological dataset where interacting elements (species) affect each other's performance (lifetime reproductive success). Though we refer to system elements as species throughout this paper, this framework can be applied to data from any interacting group of elements (e.g.\ cells, individuals, populations, species) which meet the following criteria. First, observations must include some proxy for performance, such as growth (e.g.\ biomass), fecundity (e.g.\ number of eggs laid) or chemical production (e.g.\ oxygen). Second, these observations must also record the identity and density of elements which potentially interact with each focal element. Lastly, observations should be replicated for each focal element with the aim to capture variation in the identities and densities of interaction partners. In addition to these requirements, the experimental design or data may also benefit from observations of focal elements with no interaction partners to better estimate intrinsic performance. 
    %\textbf{Changes: removed mention of 'interaction neighbourhood' and moved info about environment / interaction covariation to case study section. This is to generalise the method. [[DBS: I have a suspicion that we would need to change things if the observations are not per capita...]]}

    \paragraph{}
    We define $s$ as the number of focal species $i$, $i \in \{ 1, .., s \}$, and $t$ as the number of interacting species $j$ across all $s$ focals, $j \in \{1, ..., t \}$. Typically not all species in the system will be represented in the set of focals, such that $s \le t$. Measurements of the performance of individual units from each focal element (e.g.\ seed production of individual plants belonging to a set of focal species) are stored in a vector $p$ of length $n$ and indexed by $k$, with $k \in \{1, ..., n \}$. The densities of interaction partners are stored in a matrix $X$, of size $n \times t$. When an element $j$ was absent for a given observation $p_k$, then $X_{k,j} = 0$. Finally, the species identity of each of the $n$ focal individuals is stored in the vector $d$, of length $n$, and containing the index of the corresponding species: $d_k \in \{1, ..., s \}$.

    \subsection{Neighbour-density dependent model}
    \label{meth:nddm}    

        \paragraph{}
        We quantify the strengths of interactions by regressing the performance of a species  - alternatively, a population or any chosen set of replicated units - against the density and identity of other interacting species in a neighbour-density dependent model (NDDM).  Increases or decreases in a species' performance are thus attributed to the changing densities of its interaction partners. 

        \paragraph{}
        We implement a NDDM for each focal species $i$ which regresses the densities of species $j$ ($j = 1, ..., t$) against the measured proxy for performance $p_{k}$ through a link function $f(p_k)$:
        \begin{equation}
        f(p_{k}) = \gamma_{d_k} - \sum_{j=1}^{t} \beta_{d_k,j} \, X_{d_k,j}
        \label{nddm}
        \end{equation}
        The parameters $\beta_{d_k,j}$ capture the effect of each species $j$ on $i$ whereas the intercept $\gamma_{d_k}$ represents intrinsic performance (in the link scale), a species' performance in the absence of interactions or when all interaction effects are $0$. Note that interacting species $j$ can include members of focal species $i$ itself, in which case intraspecific interactions are captured by the parameter $\beta_{d_k,i}$. Furthermore, the equation above places no restrictions on the sign of $\beta_{d_k, j}$: interactions can be harmful to the focal species (competitive) or beneficial (facilitative). The negative sign in front of $\beta$ does, however, mean that positive interaction estimates should be interpreted as competitive and negative estimates as facilitative. Note that because $d_k$ is the focal species index for each observation, parameters making use of the $d_k$ subscript can use an $i$ subscript instead when they are no longer linked to a specific observation of performance.

        \paragraph{}
        We implement this model, as well as the RIM described below (in \ref{meth:rim}), as generalised linear models. This means that the relationship between $p_k$ and the right-hand side of the equation does not need to be linear. This can easily be changed by choosing an appropriate link function $f(p_k)$ for the data in question. In our case study, for example, we use the link function $f(p_k) = \ln(p_k)$ since we model our response variable as a negative-binomial variate.
              

    \subsection{Defining identifiable and unidentifiable interaction parameters}
    \label{meth:id_params}

    \paragraph{}
    A common issue in observational datasets is that some species or elements may not be observed to interact with many other species or to interact at sufficiently variable densities because data sampling is limited in space and time. This can create a situation in which we cannot estimate all potential interaction parameters ($\beta_{i,j}$) in the NDDM specified above, especially for rare species $j$. For an interaction parameter to be \textit{identifiable}, and thus inferrable by the NDDM, the data must contain measurements of the performance of $i$ when interacting with $j$ at varying densities. Moreover, the vector of densities of $j$ associated with measurements of focal $i$ must be linearly independent to all other vectors of densities of other species interacting with $i$. For example, if two species $a$ and $b$ interact with focal $i$ yet have the same density at every measurement or equally proportional densities at every measurement, neither $\beta_{i, a}$ nor $\beta_{i, b}$ will be inferrable by the NDDM. We define \textit{identifiable} interactions as those which are inferrable following the above assumptions, and \textit{unidentifiable} interactions as those which are not. We construct a matrix $Q$ of size $s \times t$, with $Q_{i, j} = 1$ if the corresponding $\beta_{i, j}$ parameter is identifiable, and $Q_{i, j} = 0$ if not. How we verify linear independance between vectors of neighbour densities and mathematically construct this $Q$ matrix is further described in the S. Methods Section \ref{SI:identify} and shown in the code shared with the github repository associated to this paper.
    
    \subsection{Unidentifiable parameters and the response--impact model}
    \label{meth:rim}

    \paragraph{}
    Estimating unidentifiable interaction parameters is a complex challenge for which no single answer exists. Here, we address the issue by using an alternative model which assumes that a species $i$ will typically have a singular impact ($e_i$) on and a singular response ($r_i$) to neighbours independent of neighbour identity (response and impact model, or RIM - see \cite{Godoy2014b}). A pairwise interaction parameter is therefore the product of a focal species' $i$ response parameter and an interacting species $j$ impact parameters. The density-dependent model of performance then becomes:
        \begin{equation}
        f(p_{k}) = \gamma_{d_k} - r_{d_k} \sum_{j=1}^{t} e_{j} X_{d_k, j}
        \label{rim}
        \end{equation}
    To fit the RIM, the densities of species $j$ must be linearly independent to the densities of other species and/or combinations of species, but across the entire $X$ matrix. This is in contrast to \ref{meth:nddm} above, where the densities of $j$ must be linearly independent within the subset of observations for each focal $i$. Importantly, this is a less strict condition for parameter identifiability. As a result, it is possible to estimate pairwise interactions that would be unidentifiable given Eq.~\ref{nddm} by recognizing that pairwise density dependence in Eq.~\ref{rim} is given by $\beta_{i, j} = r_{i} e_{j}$. \textbf{Readers should note that this step makes different assumptions on the structure of interactions in nature, specifically that species tend to have a generalisable effect on and response to neighbours regardless of neighbour identity. This stands in contrast to the NDDM, which assumes a unique parameter for every interaction. Such simplification is useful from a statistical point of view in order to infer unidentifiable interactions, but its ecological significance should not be dismissed.}


    \subsection{Joining the two models}
    \label{meth:addlog}

    \paragraph{}
    The interaction parameters returned by Eqs.~\ref{nddm} and \ref{rim} can be used to construct a community interaction matrix $B$ of size $s \times t$, where the effect of species $j$ on focal species $i$ corresponds to the $i$'th row and the $j$'th column of $B$. An approximation of the matrix of interactions $B$ is thus given by:
        \begin{equation}
        B = Q \circ \tilde B + (1 - Q) \circ r e^T
        \label{matB}
        \end{equation}
    where $Q$ is the matrix of identifiable interactions, and $\tilde B$ is an $s \times t$ matrix that only has free parameters inferred in the locations where $Q_{i, j} =1$. $\circ$ represents the elementwise (Hadamard) product, whereby each element $i, j$ of the first matrix is multiplied by the $i, j$ element of the second matrix, resulting in a matrix of the same dimension as the operands. In other words, the final interaction matrix $B$ takes a free parameter from the NDDM when that parameter is identifiable, and the corresponding RIM estimate, $r_i e_j$, when that parameter is not.

    \paragraph{}
    We can fit all parameters simultaneously by requiring that both the NDDM and RIM contribute to an overall joint model log likelihood:
         \begin{equation}
        \mathcal{L}_{joint} = \mathcal{L}_{RIM} + \mathcal{L}_{NDDM}
        \label{loglikjoint}
        \end{equation}
    with
        \begin{equation}
        \mathcal{L}_{RIM} = \sum_{k=1}^{n} \log ({\rm Pr} (p_k | \gamma, r, e, \dots))
        \label{logrim}
        \end{equation}
        \begin{equation}
        \mathcal{L}_{NDDM} = \sum_{k=1}^{n} \log ({\rm Pr} (p_k | \gamma, B, \dots))
        \label{lognddm}
        \end{equation}
    where both sums are across all $n$ observations, ${\rm Pr}$ is the probability density for the model (e.g.\ negative binomial), $p_k$ the vector of measured performances, $\gamma, r, e,$ and $B$ are parameters as defined in Eqs.~\ref{nddm} and \ref{rim}, and $\dots$ includes any other parameters (e.g.\ dispersion if using a negative binomial distribution for the data). Note that $p_k$ and $\gamma$ are common to both the RIM and NDDM.

    \paragraph{}
    For a hypothetical dataset with which all interactions are identifiable, then $B = \tilde B$ and fitting the RIM is not strictly necessary. The parameter vectors $r$ and $e$ would still be estimated, but they are independent of the parameters in $\tilde B$ and hence maximization of both likelihoods is independent. Conversely, if no interactions are identifiable then the joint model devolves to the RIM only. In the middle ground---where the majority of datasets are likely to lie---the joint model framework allows us to estimate free interaction parameters when possible, and use $r_i e_j$ estimates when not. An important distinction to make is that the NDDM estimates identifiable interactions only, whereas the RIM estimates all interactions, pairwise identifiable and pairwise unidentifiable. However, by maximising Eq. \ref{loglikjoint} we allow both models to provide good fits to the data but also for $r$ and $e$ to ``adjust'' around inferred values of $\tilde B$. 


    \subsection{Making interaction parameters comparable across focal species} 

        The $\beta_{i, j}$ estimates returned by the framework describe the effect of species $j$ on the performance of species $i$. Differences in the magnitude of these interaction terms may thus reflect intrinsic differences in performance, which can vary in time, space and between species. Two species may for example have different baseline values of reproductive fitness. In order to make the effects of interactions comparable between species, the interaction terms returned by both models above can be transformed into scaled interaction strengths \parencite{Laska1998}. The appropriate scaling is determined by rewriting the neighbour density-dependent model (Eq. \ref{nddm}) into a form equivalent to a Lotka-Volterra competition model: 
        \begin{equation}
        f(p_{k}) = \gamma_{d_k} \left ( 1 - \sum_{j=1}^{t} {\beta}''_{d_k, j} X_{d_k, j} \right )
        \label{LVform}
        \end{equation}
        This reveals that our interaction terms can be rescaled into interaction strengths by dividing them by the recipient element's intrinsic performance:  
        \begin{equation}
        {\beta}''_{i, j} = \frac{\beta_{i, j}}{\gamma_{i}}
        \label{scaling}
        \end{equation}
        Though this scaling step is not strictly necessary, for ecological datasets these scaled interaction strengths have the benefit of being directly comparable both across species and across environmental contexts where reproductive fitness may vary \parencite{Wootton2005}, leading to a wider range of potential applications.

    \subsection{Integrating interaction strengths into models of population dynamics}

        \paragraph{}
        In certain instances, models of species population dynamics can be used to further extend the usefulness of the framework presented here. We suggest two cases where such an application may be useful. Firstly, the variable chosen to measure the performance of focal species $p$ may not directly translate into a measure of performance which is relevant to system dynamics,  due to inherent practical constraints with collecting empirical data. For example, the life-history reproductive strategies of certain species may lead to measures of high fecundity (or performance) in the field which do not account for low survival rates post-observation \parencite{Broekman2020}. In these cases, population dynamics models can be used to account for species-specific demographic rates into estimates of interaction effects. Alternatively, we might be more interested in the effects of interacting species on the density or growth rate of a focal species rather than on it's performance. In this scenario, a population dynamic model can be used to translate interaction effects on the measured variable into interaction strengths affecting the variable of interest. 

        \paragraph{}
        In both cases, an established population dynamic model is required as well as knowledge of any crucial species-specific demographic rates. This step is illustrated for our case study in the Supplementary Methods \ref{SI:popdyn}, where an annual plant population dynamic model is used to transform effects on wildflower seed production (the measured proxy for performance) into effects on population growth, and includes species-specific estimates of seed germination and survival rates. 

        % \paragraph{}
        % Though this rescaling is not necessary when interactions are quantified as effects on rates such as growth or biomass accumulation, it is particularly useful in cases where $P_i$ is captured by variables which are affected by r/K reproductive strategies, such as seed or fruit production. Species $i$ for example may produce a high number of seeds of which few are viable, whereas species $j$ produces very few seeds though these are much more likely to mature into reproductive adults. Scaling the interaction terms returned by the models allows us to compare how species $i$ and $j$ both respond to interactions, relative to their performance. [MOVE TO DISCUSSIO?]


    \subsection{Model fitting}

        \paragraph{}        
        We implement the NDDM (Eq.~\ref{nddm}), the RIM (Eq.~\ref{rim}), and the joint model as generalised linear models in STAN \parencite{Carpenter2017}, a Bayesian statistical language where coefficient values will be estimated by MCMC sampling. Using STAN requires translating the model formula into the STAN language, setting priors for parameters to be estimated, and using an indexing system to discriminate between identifiable and unidentifiable interactions. We provide a working example of the STAN code used to specify and set this model to the case study below, as well as the necessary R scripts and functions to run the model on a simulated dataset on our public github repository \url{https://github.com/malbion/JointModelFramework}.
        From the model file, only the link function for $p_k$ and it's parameterisation need to be modified in order to apply it to a differently-distributed dataset. Additionally, non-integer measures of performance (e.g.\ biomass) should be redefined as real rather than integers in the data block. In the code given, a negative binomial distribution is used to fit seed production but a different distribution may be more appropriate when using other measures of performance.   

        \paragraph{}
        Bayesian models are often run on multiple MCMC chains. In our case, we deliberately run only one MCMC chain because the latent variables in our model ($r_i$ and $e_j$) are invariant to sign switching. This means that different MCMC chains can return coefficient values which are of the same magnitude, but opposing signs. As with the boral function in the boral R package \parencite{Hui2021} and the MCMCfactanal function in the MCMCpack package \parencite{Martin2011}, we run one chain only to simplify issues with checking chain convergence and computing parameter estimates which arise from sign-switching. Though many MCMC convergence diagnostics require multiple chains to be computed, single chain convergence can be assessed with the Geweke convergence statistic \parencite{Geweke1992}, for example with the geweke.diag() function from the coda package \parencite{Plummer2006}, as well as visually checking traceplots.

        \paragraph{}
        STAN returns parameters as distributions which maximise the likelihood, and are conditioned by the data and priors. Priors describe the distribution of plausible values which these parameters may take. For an introduction to Bayesian inference which relates the use of priors to frequentist hypothesis testing, see \textcite{Ellison1996}. We recommend investigators experiment with setting different informed priors to both improve model convergence and verify the robustness of parameter estimates. The resulting parameters are termed posterior distributions, and samples from the posterior are drawn for analysis. Using parameter distributions rather than point estimates allows for easy inclusion of uncertainty in the analysis of results, we therefore recommend bootstrap sampling from each posterior interaction strength distribution to create multiple samples of the community interaction matrix. \textcite{Ellison2004} also provides an accessible review of parameter estimates and the use of posterior distributions using a worked example on ant species richness data.

    \subsection{Dealing with sparse networks}
    \label{meth:sparse}

    \textbf{In horizontal systems, interaction networks are expected to be non-sparse because species are typically assumed to interact via the same set of shared resources. Nonetheless, it is likely that the posterior distributions of some interaction estimates returned by the model will overlap with zero. We note that an overlap with zero may be due to several factors and does not necessarily equate to an interaction being insignificant. Firstly, an overlap with zero may arise when an interaction is positive or negative depending on local conditions. Secondly, it may indicate the interaction is poorly informed and hence overlaps with zero because it has a large posterior distribution since we cannot confidently speak to its effect. Lastly, the interaction may be well-informed and weak, in which case the posterior is centered around zero.}

    \textbf{If a user of our framework has good cause to believe that many interactions are weak and the network is sparse, there are many ways to deal with this issue...} % Finish this paragraph when I know what's happening with Reviewer 1.

    Here I can add a section on sparsity - how might we eliminate parameters if we have reasonable cause to think they are $0$? Various possibilities e.g. bayesian variable selection. Point readers towards possible directions and leave decision to future users because there are many schools of thought here. 
    Instead of removing parameter, sample from prior that is on 0!
    Topher weiss-lehman's method with the erularised horseshoe prior implies scarcity 

    \subsection{Case study}

       \paragraph{}
        We applied this framework to an annual wildflower community dataset from Western Australia collected in 2016. This dataset contains over 5000 observations of individual plant seed production from 22 different focal species, and the identity and density of all neighbouring individuals within a 3 to 5 cm radius of the focal individual. This dataset included a thinning treatment where half the plots were left at natural density, whilst a quarter were thinned to 60\% density and a quarter thinned to 30\% density, thinning did not target any particular species. This served to mitigate possible confounding effects between plot location and plant density. We used the framework to quantify interactions between these 22 focal species and 52 neighbour species, and derived scaled interaction strengths with a well-supported population dynamics model for annual plants with a seed bank \parencite{Levine2009, Bimler2018} which required experimentally-measured species demographic rates. Viable seed production was used as a measure of performance and modeled with a negative binomial distribution and a log link.
        Further details on the data, the model fitting and the procedure for deriving scaled interactions from the population dynamics model are available in the Supplementary Methods \ref{SI:casestudy}.


\section{Results}
    
    \paragraph{}
    The joint model framework returns a matrix $B$ which quantifies the effect of interacting species $j$ (columns) on the performance of focal species $i$ (rows). The interactions (values) which make up $B$ can be positive or negative, non-symmetrical (the effect of element $i$ on $j$ does not necessarily match the effect of element $j$ on $i$) and include intraspecific effects (the effect of element $i$ on itself). We illustrate the advantages of this approach in the case study results below. 


    \subsection{Case study results}

    \paragraph{}
    %We first applied this joint model to simulated data to verify that the original interaction parameters could be recovered by this framework. We then applied this model to a case study dataset of a diverse annual wildflower community, where focal elements consisted of \textbf{$s = 22$} focal species and up to \textbf{$k = 52$} neighbouring species (the 22 focal species and an additional 30 species) and performance $p$ was measured as viable seed production. 
    The model returned estimates for all 1144 interactions between 22 focal species and 52 interacting species, of which 56.7\% were identifiable and estimated by the NDDM.  When accounting for interactions between focal species only, 82.0\% of interactions were identifiable. We conducted a posterior predictive check comparing simulated performance data from the joint model to observed values (Figure \ref{fig:ppcheckmu2}), this is especially important for verifying that the appropriate distribution and link function are being used for the data at hand. The joint model also returns simulated performance data for the RIM only, which we also checked visually (Supplementary Results \ref{SI:results} Figure \ref{fig:ppcheckmu1}). Model parameters were sampled 1000 times from the 80\% posterior confidence intervals returned by STAN to construct our parameter estimates. Interaction estimates were scaled according to focal intrinsic fitness into interaction strengths comparable between focal species, and we applied bootstrap sampling from each resulting interaction strength distribution to create 1000 samples of the scaled community interaction matrix.

    \paragraph{}
    For our case study, the resulting community interaction matrix was non-symmetrical and included both positive (competitive) and negative (facilitative) values, as shown in Figures \ref{fig:netwks}.A \& B. Here we represent the community matrix as a network between all 22 focal species, taking the median value of each scaled interaction  across all samples. Overall, 63.6\% of focal species had a median interspecific interaction strength which was competitive, making competition the dominant interaction type. The median value of 46.7\% of focal $\times$ neighbour interactions , however, were facilitative, as were the medians of 43.3\% of all focal $\times$ focal interactions. As a result, 47.6\% of interactions between pairs of focal species were of opposing signs such that $i$ competes with $j$ but $j$ facilitates $i$. Furthermore, the elements of the diagonal (the effect of a species on itself) were able to be estimated, which allows us to quantify how much a species regulates it's own performance. For 11 of our 22 focal species, the scaled distributions of these intraspecific effects did not overlap with 0, which suggests individuals of those species have a non-trivial effect on other individuals of the same species. \textbf{This stands in contrast to interspecific interactions, for which only 19.5\% did not overlap with 0 when considering all neighbours. It is reasonable to assume that many of those interactions were poorly informed especially with those rarer neighbours (see Methods \ref{meth:sparse}), and indeed the proportion of interspecific interactions with do not overlap with 0 jumps to 32.3\% when considering focal species only.}


    %\paragraph{}
    %We applied the same data to the cooccur package in R \parencite{Griffith2016} to build a spatial-association network, a common alternative to inferring interactions in diverse systems. Species associations (Figure \ref{fig:netwks}.C) were all negative (competitive), symmetrical, and the association between a species and itself (the equivalent to intraspecific interactions) cannot be estimated. Together, these aspects make species association networks qualitatively different to the interaction networks returned by our framework. 


    \subsection{Examples of ecological applications}

    \paragraph{}
    We illustrate a few potential applications of our framework by exploring questions of common ecological relevance and how these can be answered using the results from our case study. Each question below highlights some of the advantages of our resulting interaction network: intraspecific interactions, non-symmetrical interactions, and the ability to estimate positive and negative interactions. We were unfortunately unable to compare our results to other methods for estimating such a diverse set of plant-plant interactions because there are currently none other that we are aware of that do this.


    \subsubsection*{Do abundant natives under-regulate their population density compared to rarer native species?}
    One hypothesis as to why certain plant species are more abundant than others is that they tend to compete with themselves less strongly than rare species \parencite{Yenni2012, Yenni2017}. Hypothetically, this release from intraspecific competition pressure allows them to reach much higher densities than species which strongly compete with themselves. In our case study, we can explore this hypothesis by plotting the effect of a species on itself (the diagonal of the community interaction matrix, or intraspecific interactions) against it's density as in Figure \ref{fig:species}.A. Intraspecific interactions are at their weakest when close to $0$. The two most abundant native species \textit{Velleia rosea} (VERO) and \textit{Podolepsis canescens} (POCA) highlighted in purple fall very close to the median intraspecific interaction strength. This suggests that \textit{V. rosea} and \textit{P. canescens} do not reach high densities through an under-regulation of their population density but through other means (e.g.\ access to a larger niche space). 

    \subsubsection*{Which species may be taking on keystone roles in the system?}
    Keystone species have strong effects on the dynamics of the whole ecosystem, such that their exclusion from a community can create significant changes in species density and composition \parencite{Paine1969}. Furthermore, the impact of keystone species on other species is disproportionately large relative to their density \parencite{Power1996, Piraino2002, Libralato2006}. The keystone species concept is  relevant to ecosystem management and conservation in helping identify species of particular importance for the safeguarding of a whole system \parencite{Soule2005a}. Though determining which species truly serve keystone roles has historically involved extensive ecological experimentation (e.g.\ \cite{Paine1992}), we can identify potential candidates by comparing a species' impact on the population growth of other species to it's own density \parencite{Libralato2006}. It is important to note that because our framework allows for asymmetrical interactions, we are able to differentiate a species' impact on other species from it's response or sensitivity to neighbours \parencite{Broekman2020}. Figure \ref{fig:species}.B highlights two native species in green which may be potential keystone species due to having strongly competitive effects on the rest of the community overall, despite  low densities: \textit{Trachymene ornata} (TROR) and \textit{Gilberta tenuifolia} (GITE). 
    

    \subsubsection*{Do all exotic species compete with native species?}
    Though many invasive species compete with natives \parencite{Naeem2000, Corbin2004, Riley2008, Zheng2015}, several studies have found evidence of invasives facilitating natives, with cascading effects on other species and net positive effects on ecosystem processes \parencite{Rodriguez2006, Ramus2017, Wainwright2019}. By allowing for positive and negative interaction strengths between species in a system, we can determine which exotics are harmful or beneficial to a native's performance. Figure \ref{fig:species}.C plots the sum of a species' competitive effects on neighbours against the sum of it's facilitative effects on neighbours. Exotic species are identified in red. Out of these three exotic species, two have overall competitive effects on the community: \textit{Arctotheca calendula} (ARCA) and \textit{Pentameris aroides} (PEAI). \textit{P. aroides} interacts weakly with neighbours, whether it is competing or facilitative, and \textit{A. calendula} does compete but still lies below the median sum of competitive effects for the community, it's overall competitive effect being largely driven by weak facilitation. \textit{Hypochaeris glabra} (HYPO) on the other hand has strong effects on other species, both competitive and facilitative, and has an overall facilitative contribution to the community. The results from our case study suggest that here at least, the effects of exotic species on native species are complex and species-dependent.

    

\section{Discussion}


    \paragraph{} 
    Our novel framework quantifies the effects of interacting species and reciprocal performance, allowing the estimation of diverse, horizontal interaction matrices. The resulting matrices are non-symmetrical and can contain both positive and negative interactions, as well as the effect of a species on itself. This framework is flexible to metrics of performance, group identity (e.g.\ species, population, etc.) and diversity. We also propose a way to estimate unidentifiable interactions from those which are identifiable, \textbf{which is a significant feature given that networks for horizontal systems are expected to be non-sparse}. The matrices generated through this framework can be transformed into interaction networks through the use of further models describing the system's interaction dynamics. These features make it particularly useful in an ecological context, as illustrated in our case study on a diverse wildflower community, as well as flexible for use with data from the wide range of complex systems dominated by horizontal interactions.

    \paragraph{}
    Here, we illustrate the unique useful features of this framework using a typical plant-dominated ecological system for context. In our case study, we show how wildflower species are linked through  plant-plant interaction networks. In turn, this network can help us identify what roles specific species play within a community, and explore how the mechanisms maintaining diversity and stability operate in these systems. By estimating the effects of species on each other's performance, and subsequently their population growth and patterns of density, our method stands in contrast to association networks and returns qualitatively different information. There are a wide range of association network frameworks used in ecology \parencite{Burns2010, Losapio2018, Montesinos-Navarro2018} and collectively, they are a common alternative to estimating interaction networks in high-diversity systems as they capture spatial associations between species (e.g.\ \cite{Saiz2018}) and require easier-to-obtain data. Association networks also benefit from easy implementation with a wide range of packages in R (e.g.\ \cite{Griffith2016}) though the resulting networks are typically symmetrical and cannot capture a species' effect on itself. Moreover, association networks remain poor predictors of species interactions and rarely match empirical estimates \parencite{Sander2017,Barner2018, Thurman2019, Blanchet2020}.

    \paragraph{}
    Species interaction networks have a wide range of practical applications, such as evaluating ecosystem response to human-altered landscapes, guiding future management decisions \parencite{Ross2011} or exploring how communities may respond to global warming \parencite{Gorman2019}. Conservation and ecosystem management efforts aimed at regulating species abundances can, for example, use the information provided by an interaction network to prioritise which species to conserve or eradicate based on their role in the community. Such roles can be deduced by a species' position in the interaction network \parencite{Cirtwill2018a} and as illustrated in our case study \textbf{on a horizontal system}. Identifying keystone, foundation and other important types of species roles is also helpful for understanding biological diversity, ecosystem integrity and functioning, especially in response to disturbances and other stresses \parencite{Nyakatya2008, Orwin2016, Losapio2017, Narwani2019} \textbf{though often requires the inclusion of other trophic levels}. The examples we describe in our case study are not exhaustive, but serve to illustrate how interaction networks can help us understand both community dynamics overall and the effects \& response of specific species towards the community. 

    \paragraph{}
    Quantifying the matrix of scaled interaction strengths between species in horizontal communities can also allow us to explore how the mechanisms maintaining diversity and stability operate in these systems and across a broad number of species. Self-regulation, for example, is an extremely important driver of community stability \parencite{Barabas2017} and arises from how individuals of the same species interact with one another. Whereas same-species effects cannot be estimated by association networks, our framework quantifies intraspecific interactions and allows us to measure the strength and prevalence of competitive and facilitative density-dependence. Measures of intra and interspecific interactions can also allow us to estimate niche overlap between species (for an example, see \cite{Chu2015a}); weak interactions between species suggest that they are not sharing or competing for many resources, and thus may have large niche differences in the community. %Strong competitive self-regulation, and weak interactions between two species, are two of many mechanisms leading to stability and diversity in plant communities.

    \paragraph{}
    Another key feature of our model framework is the inclusion of facilitative interactions, which have traditionally been disregarded in plant population models and theoretical frameworks of plant diversity-maintenance. The importance of facilitative interactions to community structure and patterns of abundance has long been recognised \parencite{Callaway1997a} but there is still little consensus on how they may affect biodiversity \parencite{Bruno2003, Brooker2008}. Recent work suggests facilitation may be more widespread than traditionally thought \parencite{Gross2015, Picoche2020} and can benefit species diversity and stability depending on the circumstances \parencite{Coyte2015, Brooker2008}. Our framework provides a means to investigate the prevalence and strength of facilitation across multiple species, and how it may act in relation to competition and species diversity.  
        
    \paragraph{}
    Ultimately, quantifying species interaction networks allows us to apply tools from network theory which will help us understand not only how species interact, but also how these interactions drive community-level patterns of density and diversity. Several metrics already exist for describing horizontal network structure such as weighted connectance \parencite{Ulanowicz1991} or relative intransitivity \parencite{Laird2006a}, though these are fewer than for trophic or unweighted networks networks (e.g.\ \cite{Bersier2002, Delmas2019}). Adapting measures of nestedness or modularity for example to non-sparse networks (as as horizontal communities typically are) would allow us to further characterise how interactions and species are organised. These metrics relate to various aspects of stability and could greatly inform us on how diversity is maintained between species belonging to the same trophic level. Likewise, networks also provide several ways of measuring and describing species roles in their respective communities \parencite{Cirtwill2018a} for example through the use of structural motifs, unique patterns of interacting species which together make up the whole network. Motifs have been found to have important biological meaning in food webs \parencite{Bascompte2005a} but remain to be identified for single-trophic and bipartite networks. 

     
    % \subsection{Future research directions}
    %Though our method was developed for and tested on non-trophic systems, where interactions often cannot be deduced by other means than measuring performance, it should be applicable to trophic systems too. There are notable differences of course, chiefly our method assumes all elements have the potential to interact with one another. This is obviously not always the case for trophic systems, but you can set 'impossible' interactions to 0. Though we have not yet tested this, we welcome any tests of this method to trophic system data.
    % - adding trait or phylogeny data, for example by informing priors with trait or phylogeny distance matrix
    % ie. improving our estimates \\
    % - improving our knowledge of networks, developing tools for plant networks and tools that can deal with non-sparse networks, competitive and facilitative interactions \\
    % - integrate with trophic networks (which appear to be sensitive to producer/plant network structure!)\\

   \subsection{Limitations}


    \paragraph{}
    Our novel framework includes a versatile approach for estimating interactions between species which are not observed to cooccur. Identifiable interactions are estimated with a unique parameter, as opposed to the latent variables used to quantify unidentifiable interactions. Care should therefore be taken to assess the different assumptions behind our estimatation of identifiable and unidentifiable interactions, and how well these may apply to any particular system. It is also important to consider the likely reasons for unidentifiable interactions. Forbidden links are a subset of potential interactions which cannot be observed, often due to physical constraints (e.g.\ biological mismatch) or spatio-temporal uncoupling. For example, a pair of short-lived annual plants might have such opposing phenologies that their growing seasons never overlap in the field. We direct the reader towards the literature on forbidden interactions \parencite{Olesen2011, Jordano2016} for solving these cases. 

        %\paragraph{}
        %Our framework assumes that though the total effect of one element on another increases with density, this relationship is linear. This may not always be the case however, as interactions may be invariant to density \parencite{} or scale non-linearly \parencite{}. Our framework also evaluates direct interactions only, and does not consider higher-order interactions \parencite{}. 

    \paragraph{}
    Our model framework is aimed to helping empiricists who would like to estimate species interactions in non-trophic communities. Though the MCMC sampling algorithm does allow for many parameters to be estimated, it is crucial to check chain convergence and model behaviour to verify that the full parameter space is sampled. The amount of data required for sampling diverse communities may still be substantial. Grouping species which appear very rarely is also a common strategy to avoid over-parameterisation. In our case study, neighbour species which were recorded fewer than 10 times across all observations were grouped into an 'other' category with its own interaction effect. If interactions with or between very rare species are the explicit object of a study, however, data-collection should focus on amassing observations of focal individuals from those rarer species to be able to estimate  interaction strengths.   

\subsection{Conclusion}

    \paragraph{} 
    There is now a rich body of work describing the characteristics of food web, plant-pollinator and host-parasite interactions, but fewer network approaches focus on non-trophic interactions such as those occurring between plants \parencite{Ellison2019}. Here we present a novel framework which makes the process of inferring  interactions in horizontal systems easier, whilst allowing for many and multiple types (competitive and facilitative) of interactions. In turn, this allows the application of  network theory tools to the management of non-trophic systems, as well as to deepening our understanding of diversity, stability and other community-level properties which emerge from interactions. By applying our framework to a wildflower case study, we find that over-abundant species do not appear to self-regulate more strongly than rare species, contrary to expectations. We also identify species which have strong effects on their neighbours, and which exotic species may be more of a threat to the native community. Though we illustrate our study with one particular ecological dataset, the method presented here could be adapted for use on a wider array of  horizontal systems such as those found in microbial, neural, and social networks. 
   

% \bibliography{../../../BibTex_files/03_Chapter3}
% \bibliographystyle{plainnat}

\section*{Acknowledgements}

We thank M. Raymundo \& I. Towers for the seed rate data used in this paper, C. Bowler, T. Britton, and J. Ikin for their work in sample processing for this data set, as well as Rob Freckleton and Jacopo Grilli for insightful comments on the manuscript. We would also like to thank Stefano Allesina and two anonymous reviewers for their valuable comments on an earlier version of this manuscript. We also wish to acknowledge the Traditional Custodians of the Country from which the case study data was collected, the Yamatji People, as well as those of the land on which this research was conceived of, carried out, and written, the Jagera and Turrbal Peoples. This work was made possible by funding awarded to M.M.M. (DP170100837) by the Australian Research Council. D.B.S. is grateful for the support of the Marsden Fund Council, from New Zealand Government funding (grant 16-UOC-008).


\section*{Competing interests}

The authors declare no competing interests. 


\newpage

\printbibliography   

\end{refsection}

\newpage 

\section{Figures}


    \begin{figure}[H]
       % \hspace*{-3.5cm}
        \includegraphics[width=.6\textwidth]{../../3.analyses/figures_mss/postpredch_mu2.png}
        \caption{Posterior predictive check showing the density distribution of observed seed production values (red line) to simulated seed production values (light grey) as estimated by the joint model, on a log scale. Simulated values were generated using the 80\% posterior confidence intervals for each parameter, the black line shows simulated values using the median of each parameter. }
        \label{fig:ppcheckmu2}
    \end{figure}

    \begin{figure}[H]
        \begin{centering}
        % Looks like GITE is in larger font???
        \includegraphics[width=0.5\textwidth]{../../3.analyses/figures_mss/networks_C_F.png}
        \caption{Competitive (A) and facilitative (B) scaled interaction networks estimated from our model framework. Competitive and facilitative interactions (A and B) are here shown separately for ease of view but were analysed together. Only focal species are included in these networks, arrows point to species $i$ and line thickness denotes interaction strength. Interaction strengths are given as the median over 1000 samples. Purple coloured nodes correspond to highly abundant native species, whereas green nodes indicate potential keystone species, as further described in Figure \ref{fig:species}.}
        \label{fig:netwks}
       \end{centering}
    \end{figure}  


    \begin{figure}[H]
        \begin{centering}
        \includegraphics[width=0.4\textwidth]{../../3.analyses/figures_mss/species_effects.png}
        \caption{(Caption next page.)}
        \label{fig:species}
        \end{centering}
    \end{figure} 

    \addtocounter{figure}{-1}
    \begin{figure} [t!]
        \caption{(Previous page.) Understanding interaction effects can help identify species of particular ecological importance to a system. For all graphs, diamonds are species medians across all network samples, black lines cover the 50\% quantile and grey dots indicate the full range of out-strength values as calculated from 1000 sampled networks. The shaded part of the graphs show facilitative (negative) interactions. Dashed lines represent the median value for all focals. Coloured triangles indicate the species refered to in the main text for each of the ecological questions associated with (A), (B) and (C). \\
        In (A), the x-axis shows the strength of scaled intraspecific interactions, that is how strongly a focal species interacts with itself, plotted against a focal species' total log abundance (y-axis). Values over $0$ indicate competition, and values less than $0$ indicate facilitation.  The two most abundant natives, \textit{Velleia rosea} (VERO) and \textit{Podolepsis canescens} (POCA) in purple, do not seem to compete with themselves any more or less strongly than the median for all species in the system (dashed line). \\
        (B) shows the sum of interaction effects of focal species on neighbours (x-axis) against the focal species' total log abundance (x-axis). On the x-axis, values greater than $0$ indicate that a focal species has an overall competitive effect on neighbours, and values less than $0$ indicate that it has an overall facilitative effect. Green diamonds identify species with low overall abundance but strong competitive effects on neighbours: \textit{Trachymene ornata} (TROR) and \textit{Gilberta tenuifolia} (GITE). \\
        (C) decomposes a focal species' net interaction strength into its competitive effects (x-axis) and facilitative effects (y-axis). Red diamonds show the exotic species \textit{Hypochaeris glabra} (HYPO), \textit{Arctotheca calendula} (ARCA) and \textit{Pentameris aroides} (PEAI). The light grey diagonal shows where x = y, species above that line have an overall facilitative effect on other species whereas those below that line have an overall competitive effect.} 
    \end{figure}

\clearpage
\newpage

    % \begin{figure}[H]
    %     \begin{centering}
    %     \includegraphics[width=0.4\textwidth]{../../3.analyses/figures_mss/cooccur_vs_abund.png}
    %     \caption{Absolute sum of focal species association strengths as returned by the cooccur package (x-axis), plotted against their log density (y-axis). Dashed lines are the median for all focals. In green are the same potential keystone species as identified in Fig. \ref{fig:species}.B: \textit{Trachymene ornata} (TROR) and \textit{Gilberta tenuifolia} (GITE). Because association strengths are derived from densities, rare species also tend to have weaker summed association strengths which makes identifying potential keystone species challenging.}
    %     \label{fig:coocab}
    %     \end{centering}
    % \end{figure} 


% END OF MAIN TEXT 
\include{supps}

\end{document}